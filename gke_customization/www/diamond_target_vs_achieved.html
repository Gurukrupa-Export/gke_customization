{% extends "templates/web.html" %}

{% block page_content %}
<!-- Load Custom Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #fff;
        color: #333;
    }

    .navbar .navbar-brand {
        display: none !important;
    }

    #dashboard-container {
        position: relative;
    }

    #loading-message {
        text-align: center;
        padding: 40px;
    }

    #loading-message h3 {
        font-weight: 600;
        font-size: 20px;
        color: #2c3e50;
    }

    #loading-message p {
        color: #777;
    }

    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin: 20px auto;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #unauthorized-message {
        display: none;
        text-align: center;
        padding: 80px;
    }

    #unauthorized-message h1 {
        color: #e74c3c;
    }

    #unauthorized-message p {
        color: #555;
        font-size: 16px;
    }

    #unauthorized-message a {
        margin-top: 20px;
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 5px;
    }

    iframe {
        width: 100%;
        height: 700px;
        border: none;
        display: none;
    }

    @media only screen and (max-width: 600px) {
        iframe {
            height: 500px;
        }
    }
</style>

<div id="debug-info" style="padding: 20px; background: #f5f5f5; margin-bottom: 20px; display: none;">
    <h3>Debug Information</h3>
    <div id="status-message">Initializing...</div>
</div>

<div id="secure-content" style="display: none;">
    <h5>
        <img src="http://gkexport.frappe.cloud/files/GK-removebg-preview.png" style="height: 50px;">
        Gurukrupa Export
    </h5>
    <div id="dashboard-container">
        <iframe id="metabase-frame" 
            src="http://3.108.219.130:3000/public/dashboard/7e3825a6-1a79-4ca8-9140-b50aaa640c00"
            allowtransparency="true">
        </iframe>
        <div id="loading-message">
            <h3>üîç Turning data into decisions...</h3>
            <p>Loading the truth behind the numbers. Please wait.</p>
            <div class="loader"></div>
        </div>
    </div>
</div>

<div id="unauthorized-message">
    <h1>üö´ Access Denied</h1>
    <p>You don‚Äôt have permission to view this dashboard.<br>Please contact your administrator if you believe this is a mistake.</p>
    <a href="/login">Login</a>
</div>

<script>
    function updateStatus(message) {
        // console.log('Status:', message);
        // document.getElementById('status-message').innerHTML = message;
    }

    frappe.ready(function () {
        updateStatus('Page ready. Checking session...');

        if (!frappe.session || !frappe.session.user || frappe.session.user === 'Guest') {
            updateStatus('No valid session. Redirecting...');
            window.location.href = '/login?redirect-to=' + encodeURIComponent(window.location.pathname);
        } else {
            const currentUser = frappe.session.user;
            updateStatus('Logged in as: ' + currentUser);

            frappe.call({
                method: 'gke_customization.www.hr_dashboard.get_current_user_roles',
                callback: function (response) {
                    const userRoles = response.message || [];
                    let isAuthorized = false;

                    if (currentUser === 'Administrator' || userRoles.includes('System Manager')) {
                        isAuthorized = true;
                        updateStatus('User is authorized. Showing content.');

                        document.getElementById('secure-content').style.display = 'block';
                        document.getElementById('loading-message').style.display = 'block';

                        // Show iframe with fade-in effect
                        setTimeout(function () {
                            const iframe = document.getElementById('metabase-frame');
                            document.getElementById('loading-message').style.display = 'none';
                            iframe.style.display = 'block';
                            iframe.style.opacity = 0;
                            iframe.style.transition = 'opacity 0.8s ease-in-out';
                            setTimeout(() => {
                                iframe.style.opacity = 1;
                            }, 50);
                            updateStatus('Dashboard loaded successfully');
                        }, 1000);
                    } else {
                        updateStatus('Access denied - Not authorized.');
                        document.getElementById('unauthorized-message').style.display = 'block';
                        setTimeout(function () {
                            window.location.href = '/login?redirect-to=' + encodeURIComponent(window.location.pathname);
                        }, 2000);
                    }
                },
                error: function (err) {
                    updateStatus('Error fetching roles: ' + JSON.stringify(err));
                    document.getElementById('unauthorized-message').style.display = 'block';
                }
            });
        }
    });

    // Disable right-click
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        return false;
    });

    // Disable shortcut keys
    document.addEventListener('keydown', function (e) {
        if (e.ctrlKey && ['s', 'p', 'u'].includes(e.key.toLowerCase())) {
            e.preventDefault();
            return false;
        }
    });

    // Optional: Check iframe origin (update if Metabase origin changes)
    window.addEventListener('message', function (e) {
        if (e.origin !== "http://3.108.219.130:3000") {
            console.warn('Blocked message from untrusted origin:', e.origin);
        }
    });
</script>
{% endblock %}
